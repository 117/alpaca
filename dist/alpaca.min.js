!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("bottleneck"),require("qs"),require("ky-universal"),require("isomorphic-ws"),require("eventemitter3")):"function"==typeof define&&define.amd?define(["exports","bottleneck","qs","ky-universal","isomorphic-ws","eventemitter3"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).alpaca={},t.Bottleneck,t.qs,t.ky,t.WebSocket,t.EventEmitter)}(this,(function(t,e,r,n,i,a){"use strict";function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=s(e),c=s(r),u=s(n),l=s(i),p=s(a),d=function(t,e){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)};var f=function(){return(f=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function h(t,e,r,n){return new(r||(r=Promise))((function(i,a){function s(t){try{c(n.next(t))}catch(t){a(t)}}function o(t){try{c(n.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,o)}c((n=n.apply(t,e||[])).next())}))}function y(t,e){var r,n,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}var _={rest:{account:"https://api.alpaca.markets/v2",market_data:"https://data.alpaca.markets/v1"},websocket:{account:"wss://api.alpaca.markets/stream",account_paper:"wss://paper-api.alpaca.markets/stream",market_data:"wss://data.alpaca.markets/stream"}};function m(t){if(t)try{return f(f({},t),{raw:function(){return t},created_at:new Date(t.created_at),updated_at:new Date(t.updated_at),submitted_at:new Date(t.submitted_at),filled_at:new Date(t.filled_at),expired_at:new Date(t.expired_at),canceled_at:new Date(t.canceled_at),failed_at:new Date(t.failed_at),replaced_at:new Date(t.replaced_at),qty:q(t.qty),filled_qty:q(t.filled_qty),type:t.type,side:t.side,time_in_force:t.time_in_force,limit_price:q(t.limit_price),stop_price:q(t.stop_price),filled_avg_price:q(t.filled_avg_price),status:t.status,legs:v(t.legs),trail_price:q(t.trail_price),trail_percent:q(t.trail_percent),hwm:q(t.hwm)})}catch(t){throw new Error("Order parsing failed. "+t.message)}}function v(t){return t?t.map((function(t){return m(t)})):void 0}function w(t){if(t)try{return f(f({},t),{raw:function(){return t},avg_entry_price:q(t.avg_entry_price),qty:q(t.qty),side:t.side,market_value:q(t.market_value),cost_basis:q(t.cost_basis),unrealized_pl:q(t.unrealized_pl),unrealized_plpc:q(t.unrealized_plpc),unrealized_intraday_pl:q(t.unrealized_intraday_pl),unrealized_intraday_plpc:q(t.unrealized_intraday_plpc),current_price:q(t.current_price),lastday_price:q(t.lastday_price),change_today:q(t.change_today)})}catch(t){throw new Error("Position parsing failed. "+t.message)}}function g(t){if(t)try{return f(f({},t),{raw:function(){return t},cum_qty:q(t.cum_qty),leaves_qty:q(t.leaves_qty),price:q(t.price),qty:q(t.qty),side:t.side,type:t.type})}catch(t){throw new Error("TradeActivity parsing failed. "+t.message)}}function b(t){if(t)try{return f(f({},t),{raw:function(){return t},net_amount:q(t.net_amount),qty:q(t.qty),per_share_amount:q(t.per_share_amount)})}catch(t){throw new Error("NonTradeActivity parsing failed. "+t.message)}}function q(t){return void 0===t?t:parseFloat(t)}var k={account:function(t){if(t)try{return f(f({},t),{raw:function(){return t},buying_power:q(t.buying_power),regt_buying_power:q(t.regt_buying_power),daytrading_buying_power:q(t.daytrading_buying_power),cash:q(t.cash),created_at:new Date(t.created_at),portfolio_value:q(t.portfolio_value),multiplier:q(t.multiplier),equity:q(t.equity),last_equity:q(t.last_equity),long_market_value:q(t.long_market_value),short_market_value:q(t.short_market_value),initial_margin:q(t.initial_margin),maintenance_margin:q(t.maintenance_margin),last_maintenance_margin:q(t.last_maintenance_margin),sma:q(t.sma),status:t.status})}catch(t){throw new Error("Account parsing failed. "+t.message)}},activities:function(t){if(t)try{return t.map((function(t){return"FILL"===t.activity_type?g(t):b(t)}))}catch(t){throw new Error("Activity parsing failed. "+t.message)}},clock:function(t){if(t)try{return{raw:function(){return t},timestamp:new Date(t.timestamp),is_open:t.is_open,next_open:new Date(t.next_open),next_close:new Date(t.next_close)}}catch(t){throw new Error("Order parsing failed. "+t.message)}},nonTradeActivity:b,order:m,orders:v,position:w,positions:function(t){return t?t.map((function(t){return w(t)})):void 0},tradeActivity:g},E=function(){function t(t){if(this.params=t,this.limiter=new o.default({reservoir:200,reservoirRefreshAmount:200,reservoirRefreshInterval:6e4,maxConcurrent:1,minTime:200}),"access_token"in t.credentials&&("key"in t.credentials||"secret"in t.credentials))throw new Error("can't create client with both default and oauth credentials")}return t.prototype.isAuthenticated=function(){return h(this,void 0,void 0,(function(){return y(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.getAccount()];case 1:return t.sent(),[2,!0];case 2:return t.sent(),[2,!1];case 3:return[2]}}))}))},t.prototype.getAccount=function(){return h(this,void 0,void 0,(function(){var t,e;return y(this,(function(r){switch(r.label){case 0:return e=(t=k).account,[4,this.request("GET",_.rest.account,"account")];case 1:return[2,e.apply(t,[r.sent()])]}}))}))},t.prototype.getOrder=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return r=(e=k).order,[4,this.request("GET",_.rest.account,"orders/"+(t.order_id||t.client_order_id)+"?"+c.default.stringify({nested:t.nested}))];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.getOrders=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return r=(e=k).orders,[4,this.request("GET",_.rest.account,"orders?"+c.default.stringify(t))];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.placeOrder=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return r=(e=k).order,[4,this.request("POST",_.rest.account,"orders",t)];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.replaceOrder=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return r=(e=k).order,[4,this.request("PATCH",_.rest.account,"orders/"+t.order_id,t)];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.cancelOrder=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return r=(e=k).order,[4,this.request("DELETE",_.rest.account,"orders/"+t.order_id)];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.cancelOrders=function(){return h(this,void 0,void 0,(function(){var t,e;return y(this,(function(r){switch(r.label){case 0:return e=(t=k).orders,[4,this.request("DELETE",_.rest.account,"orders")];case 1:return[2,e.apply(t,[r.sent()])]}}))}))},t.prototype.getPosition=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return r=(e=k).position,[4,this.request("GET",_.rest.account,"positions/"+t.symbol)];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.getPositions=function(){return h(this,void 0,void 0,(function(){var t,e;return y(this,(function(r){switch(r.label){case 0:return e=(t=k).positions,[4,this.request("GET",_.rest.account,"positions")];case 1:return[2,e.apply(t,[r.sent()])]}}))}))},t.prototype.closePosition=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return r=(e=k).order,[4,this.request("DELETE",_.rest.account,"positions/"+t.symbol)];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.closePositions=function(){return h(this,void 0,void 0,(function(){var t,e;return y(this,(function(r){switch(r.label){case 0:return e=(t=k).orders,[4,this.request("DELETE",_.rest.account,"positions")];case 1:return[2,e.apply(t,[r.sent()])]}}))}))},t.prototype.getAsset=function(t){return this.request("GET",_.rest.account,"assets/"+t.asset_id_or_symbol)},t.prototype.getAssets=function(t){return this.request("GET",_.rest.account,"assets?"+c.default.stringify(t))},t.prototype.getWatchlist=function(t){return this.request("GET",_.rest.account,"watchlists/"+t.uuid)},t.prototype.getWatchlists=function(){return this.request("GET",_.rest.account,"watchlists")},t.prototype.createWatchlist=function(t){return this.request("POST",_.rest.account,"watchlists",t)},t.prototype.updateWatchlist=function(t){return this.request("PUT",_.rest.account,"watchlists/"+t.uuid,t)},t.prototype.addToWatchlist=function(t){return this.request("POST",_.rest.account,"watchlists/"+t.uuid,t)},t.prototype.removeFromWatchlist=function(t){return this.request("DELETE",_.rest.account,"watchlists/"+t.uuid+"/"+t.symbol)},t.prototype.deleteWatchlist=function(t){return this.request("DELETE",_.rest.account,"watchlists/"+t.uuid)},t.prototype.getCalendar=function(t){return this.request("GET",_.rest.account,"calendar?"+c.default.stringify(t))},t.prototype.getClock=function(){return h(this,void 0,void 0,(function(){var t,e;return y(this,(function(r){switch(r.label){case 0:return e=(t=k).clock,[4,this.request("GET",_.rest.account,"clock")];case 1:return[2,e.apply(t,[r.sent()])]}}))}))},t.prototype.getAccountConfigurations=function(){return this.request("GET",_.rest.account,"account/configurations")},t.prototype.updateAccountConfigurations=function(t){return this.request("PATCH",_.rest.account,"account/configurations",t)},t.prototype.getAccountActivities=function(t){return h(this,void 0,void 0,(function(){var e,r;return y(this,(function(n){switch(n.label){case 0:return t.activity_types&&Array.isArray(t.activity_types)&&(t.activity_types=t.activity_types.join(",")),r=(e=k).activities,[4,this.request("GET",_.rest.account,"account/activities"+(t.activity_type?"/".concat(t.activity_type):"")+"?"+c.default.stringify(t))];case 1:return[2,r.apply(e,[n.sent()])]}}))}))},t.prototype.getPortfolioHistory=function(t){return this.request("GET",_.rest.account,"account/portfolio/history?"+c.default.stringify(t))},t.prototype.getBars=function(t){var e=f(f({},t),{symbols:t.symbols.join(",")});return this.request("GET",_.rest.market_data,"bars/"+t.timeframe+"?"+c.default.stringify(e))},t.prototype.getLastTrade=function(t){return this.request("GET",_.rest.market_data,"last/stocks/"+t.symbol)},t.prototype.getLastQuote=function(t){return this.request("GET",_.rest.market_data,"last_quote/stocks/"+t.symbol)},t.prototype.request=function(t,e,r,n){var i=this,a={};if("access_token"in this.params.credentials?a.Authorization="Bearer "+this.params.credentials.access_token:(a["APCA-API-KEY-ID"]=this.params.credentials.key,a["APCA-API-SECRET-KEY"]=this.params.credentials.secret,this.params.credentials.key.startsWith("PK")&&e==_.rest.account&&(e=_.rest.account.replace("api.","paper-api."))),n)for(var s=0,o=Object.entries(n);s<o.length;s++){var c=o[s],l=c[0],p=c[1];p instanceof Date&&(n[l]=p.toISOString())}return new Promise((function(s,o){return h(i,void 0,void 0,(function(){var i,c=this;return y(this,(function(l){switch(l.label){case 0:return i=function(){return u.default(e+"/"+r,{method:t,headers:a,body:JSON.stringify(n)})},[4,(this.params.rate_limit?function(){return c.limiter.schedule(i)}:i)().then((function(t){return h(c,void 0,void 0,(function(){return y(this,(function(e){switch(e.label){case 0:return[4,t.json().catch((function(){return!1}))];case 1:return[2,e.sent()||{}]}}))}))})).then((function(t){return"code"in t&&"message"in t?o(t):s(t)})).catch(o)];case 1:return l.sent(),[2]}}))}))}))},t}(),T=function(t){function e(e){var r=t.call(this)||this;switch(r.params=e,r.subscriptions=[],r.authenticated=!1,e.stream){case"account":r.host=e.credentials.key.startsWith("PK")?_.websocket.account_paper:_.websocket.account;break;case"market_data":r.host=_.websocket.market_data;break;default:r.host="unknown"}return r.connection=new l.default(r.host).once("open",(function(){r.authenticated||r.connection.send(JSON.stringify({action:"authenticate",data:{key_id:e.credentials.key,secret_key:e.credentials.secret}})),r.emit("open",r)})).once("close",(function(){return r.emit("close",r)})).on("message",(function(t){var e=JSON.parse(t.toString());if("stream"in e&&"authorization"==e.stream){if("authorized"!=e.data.status)throw r.connection.close(),new Error("There was an error in authorizing your websocket connection. Object received: "+JSON.stringify(e,null,2));r.authenticated=!0,r.emit("authenticated",r),console.log("Connected to the websocket.")}if(r.emit("message",e),"stream"in e){r.emit({trade_updates:"trade_updates",account_updates:"account_updates",T:"trade",Q:"quote",AM:"aggregate_minute"}[e.stream.split(".")[0]],e.data)}})).on("error",(function(t){return r.emit("error",t)})),r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}d(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.send=function(t){if(!this.authenticated)throw new Error("You can't send a message until you are authenticated!");return"object"==typeof t&&(t=JSON.stringify(t)),this.connection.send(t),this},e.prototype.subscribe=function(t){var e;return(e=this.subscriptions).push.apply(e,t),this.send(JSON.stringify({action:"listen",data:{streams:t}}))},e.prototype.unsubscribe=function(t){for(var e=0,r=this.subscriptions.length;e<r;e++)t.includes(this.subscriptions[e])&&this.subscriptions.splice(e,1);return this.send(JSON.stringify({action:"unlisten",data:{streams:t}}))},e}(p.default),A={AlpacaClient:E,AlpacaStream:T};t.AlpacaClient=E,t.AlpacaStream=T,t.default=A,Object.defineProperty(t,"__esModule",{value:!0})}));
